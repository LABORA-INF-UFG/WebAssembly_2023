<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>inBrowser</title>
</head>
<body>
    <script type="module">
        import { AlvaAR } from '/scripts/alva_ar.js';
        import getVideoFrames from "/scripts/mod.js" 

        const eventEnd = new Event("end");
        let totalSlamTime = 0

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const width = 480
        const height = 848

        function saveResultsToCSV(data) {
            const csvContent = "data:text/csv;charset=utf-8," +
                "Average Slam Time,Total Frames\n" +
                data.map(row => Object.values(row).join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "experiment_results.csv");
            document.body.appendChild(link);
            link.click();
        }
        
        async function main(){
            
            const alva = await AlvaAR.Initialize(width, height)

            const processFrame = (raw_frame) => {
                ctx.clearRect(0, 0, width, height);
                ctx.drawImage(raw_frame, 0, 0, width, height);
                const frame = ctx.getImageData(0, 0, width, height);
            
                const startSlamTime = performance.now();
                    
                const pose = alva.findCameraPose(frame);
                const planePose = alva.findPlane();
                const dots = alva.getFramePoints();

                const endSlamTime = performance.now();

                totalSlamTime += (endSlamTime - startSlamTime)
            }

            const url = '/videos/wasm.mp4'
            let response = await fetch(url);
            let blob = await response.blob();
            let videoUrl = URL.createObjectURL(blob);
            let frameCount = 0;
            
            if(alva){
                await getVideoFrames({
                    videoUrl,
                    onFrame(frame){
                        processFrame(frame)
                        frameCount++

                        frame.close()
                    },
                    onConfig(config) {
    
                    },
                    onFinish() {
                        console.log("finished!");
                        console.log("frameCount ", frameCount);
                        console.log("Slam Mean ", totalSlamTime/frameCount)
                          
                        const result = [{
                            averageSlamTime: totalSlamTime / frameCount,
                            totalFrames: frameCount
                        }]
                        
                        saveResultsToCSV(result)
                        ctx.clearRect(0, 0, width, height);
                        window.dispatchEvent(eventEnd);
                    },
                })
            }
        }
        window.addEventListener('load', main);
    </script>    
</body>
</html>
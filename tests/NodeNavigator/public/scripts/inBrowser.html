<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>inBrowser</title>
</head>
<body>
    <script type="module">
        import { AlvaAR } from '/scripts/alva_ar.js';
        const eventEnd = new Event("end");
        let result = []

        function startAnimating(fps) {
            fpsInterval = 1000 / fps;
            then = performance.now();
            startTime = then;
            processFrame();
        }

        async function processFrame() {
            if (video.paused || video.ended) {
                console.log("Average slam time: " + totalTime/count)
                console.log("Total Frames: "+ count)
                
                result.push({
                    averageSlamTime: totalTime / count,
                    totalFrames: count
                });
                
                saveResultsToCSV(result)
                window.dispatchEvent(eventEnd);

                return;
            }
        
            requestAnimationFrame(processFrame);

            now = performance.now();
            elapsed = now - then;

            if(elapsed > fpsInterval){
                then = now - (elapsed % fpsInterval);
            
                ctx.clearRect( 0, 0, width, height );
                ctx.drawImage( video, 0, 0, width, height );
                
                const frame = await ctx.getImageData( 0, 0, width, height );
                
                let startSlam, endSlam = 0
                
                await new Promise (async resolve =>  {
                    startSlam = await performance.now()
                    const pose = await alva.findCameraPose(frame);
                    const planePose = await alva.findPlane();
                    const dots = await alva.getFramePoints();
                    endSlam = await performance.now()

                    count++
                    resolve()
                })
            
            

                const slamTime = endSlam - startSlam;

                totalTime+=slamTime
            
            }
            
        }



        function saveResultsToCSV(data) {
            const csvContent = "data:text/csv;charset=utf-8," +
                "Average Slam Time,Total Frames\n" +
                data.map(row => Object.values(row).join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "experiment_results.csv");
            document.body.appendChild(link);
            link.click();
        }

        
        let totalTime = 0
        let count = 0;
        var fps, fpsInterval, startTime, now, then, elapsed;

        const video = document.createElement('video')
        video.src = ' /videos/video-short.mp4'
        video.autoplay = true;
        video.muted = true;
        video.loop = false; 
            
        await video.play();
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const width = video.videoWidth;
        const height = video.videoHeight;
        canvas.width = width;
        canvas.height = height;
        
        const alva = await AlvaAR.Initialize(width, height)
        
     
        startAnimating(35)
            

        
        
        
    </script>
</body>
</html>